DECLARE l_file integer;
DECLARE v_count integer;
DECLARE v_i integer;
DECLARE temp_file TABLE (v_file varchar( 16 ) );
DECLARE c_file varchar( 16 );

it_Res = SELECT * FROM :intab
         WHERE REC_ID = 'RES';

SELECT COUNT( * ) INTO v_count FROM :it_Res;

-- insertamos el campo id archivo en una tabla interna
it_file = SELECT  ADQNT_ID AS FILE_ID
            FROM :inTab
            WHERE REC_ID = 'RES';

 -- insertamos su longitud en la variable que hemos creado
 l_file = length( :it_file.FILE_ID[ 1 ] );

 tLin1 = SELECT  '' AS RECORDMODE,
       REC_ID,
       LIN_NUM,
       ADQNT_ID,
       ROUTE,
       VEND_ACC,
       VIR_STR,
       PAY_GATE,
       ORDER_ID,
       RMA,
       DATE_ADQ,
       TIMEZONE_ADQ,
       TRAN_AMNT,
       TRAN_CURR,
       TRAN_SET_AMNT,
       TRAN_GRS_AMNT,
       TRAN_NET_AMNT,
       SET_CURR,
       EXC_AMNT,
       EXC_FRG_CURR,
       EXC_RATE,
       EXC_AMNT_CNVT,
       COM_AMNT,
       COM_AMNT_CURR,
       TRAN_REF_NUM,
       TRAN_REF_NUM2,
       ARN,
       RECLN_ID,
       LEFT(RECLN_ID, l_file) AS FILE_ID,
       "/BIC/TIP_TRANS",
       PAY_METHOD,
       "/BIC/MED_PAGO",
       BATCH_ID,
       INST_PAID,
       TOT_AMNT_INST,
       INTCHANGE,
       SCH_FEE,
       MARKUP,
       PAY_METH_CAT,
       TRANS_ID,
       TRANS_AUTH_NUM,
       TRANS_OPER_NUM,
       PAN_CARD_NUM,
       TERM_ID,
       INSTALM,
       NUM_INSTAL,
       DCC,
       DCC_REB,
       CARD_READ_MET,
       LOYAL_POINT,
       "/BIC/ZADTFILE1",
       TYPE_CHAN,
       AUX1,
       AUX2,
       AUX3,
       AUX4,
       AUX5,
       AUX6,
       AUX7,
       AUX8,
       AUX9,
       AUX10,
       '' AS ZADCALDAY,
       DENSE_RANK( ) OVER(ORDER BY LEFT(RECLN_ID, l_file)) AS ZADFILNUM,
       RECORD,
       SQL__PROCEDURE__SOURCE__RECORD
       FROM :inTab
       WHERE REC_ID = 'LIN';

   tAuxRes = SELECT REC_ID,
       LIN_NUM,
       ADQNT_ID,
       ROUTE,
       VEND_ACC,
       c_file AS FILE
       FROM :intab
       WHERE REC_ID = 'AUX' AND LIN_NUM = 3;

 for v_i in 1..v_count do

       temp_file.v_file[ v_i ] = :it_Res.ADQNT_ID[ v_i ];

       tAuxRes.FILE[ v_i ]  =  :temp_file.v_file[ v_i ];

 end for;

 tAux1 = SELECT SUBSTRING(VEND_ACC, 1, 8)  AS ZADCALDAY,
         FILE,
         DENSE_RANK( ) OVER(ORDER BY  FILE) AS ZADFILNUM
         FROM :tAuxRes;

 tAuxLin = SELECT '' AS RECORDMODE,
       REC_ID AS ZADRECID1,
       LIN_NUM AS ZADLINUM1,
       ADQNT_ID AS ZADACQID,
       ROUTE AS ZADROUTE1,
       VEND_ACC AS ZADVENAC1,
       VIR_STR AS ZADVIRSTO,
       PAY_GATE AS ZADPAYGAT,
       ORDER_ID AS ZADORDID1,
       RMA AS ZADRMA1,
       DATE_ADQ AS ZADFECHA1,
       TIMEZONE_ADQ AS ZADTMZN1,
       TRAN_AMNT AS ZADTRAMT1,
       TRAN_CURR AS ZADTRCUR1,
       TRAN_SET_AMNT AS ZADTRSAM1,
       TRAN_GRS_AMNT AS ZADTRGAM1,
       TRAN_NET_AMNT AS ZADTRNAM1,
       SET_CURR AS ZADSTCUR1,
       EXC_AMNT AS ZADEXAMN1,
       EXC_FRG_CURR AS ZADEXFCU1,
       EXC_RATE AS ZADEXRAT1,
       EXC_AMNT_CNVT AS ZADEXAMC1,
       COM_AMNT AS ZADCAMNT1,
       COM_AMNT_CURR AS ZADCAMCU1,
       TRAN_REF_NUM AS ZADTRFNU1,
       TRAN_REF_NUM2 AS ZADTRFNU2,
       ARN AS ZADARN1,
       RECLN_ID AS ZADRELID1,
       "/BIC/TIP_TRANS" AS "/BIC/ZADTRANS1",
       PAY_METHOD AS ZADPYMET1,
       "/BIC/MED_PAGO" AS "/BIC/ZADMEPAG1",
       BATCH_ID AS ZADBATID1,
       INST_PAID AS ZADINSPA1,
       TOT_AMNT_INST AS ZADTAMIN1,
       INTCHANGE AS ZADINCNG1,
       SCH_FEE AS ZADSCFEE1,
       MARKUP AS ZADMRKUP1,
       PAY_METH_CAT AS ZADPAYMC1,
       TRANS_ID AS ZADTRNID1,
       TRANS_AUTH_NUM AS ZADTRAUN1,
       TRANS_OPER_NUM AS ZADTROPN1,
       PAN_CARD_NUM AS ZADPANCN1,
       TERM_ID AS ZADTERID1,
       INSTALM AS "/BIC/ZADINST1",
       NUM_INSTAL AS ZADNINST1,
       DCC AS "/BIC/ZADDCC1",
       DCC_REB AS ZADDCCRB1,
       CARD_READ_MET AS ZADCRMTH1,
       LOYAL_POINT AS "/BIC/ZADLOYLP1",
       "/BIC/ZADTFILE1" AS "/BIC/ZADTFILE1",
       TYPE_CHAN AS ZADTCHAN1,
       AUX1 AS ZADAUX1,
       AUX2 AS ZADAUX2,
       AUX3 AS ZADAUX3,
       AUX4 AS ZADAUX4,
       AUX5 AS ZADAUX5,
       AUX6 AS ZADAUX6,
       AUX7 AS ZADAUX7,
       AUX8 AS ZADAUX8,
       AUX9 AS ZADAUX9,
       AUX10 AS ZADAUX10,
       :tAux1.ZADCALDAY,
       :tLin1.ZADFILNUM,
       RECORD,
       SQL__PROCEDURE__SOURCE__RECORD
       FROM :tLin1
       INNER JOIN :tAux1
       ON :tAux1.ZADFILNUM = :tLin1.ZADFILNUM;

   t8 = SELECT  '' AS RECORDMODE,
                REC_ID AS ZADRECID1,
                LIN_NUM AS ZADLINUM1,
                ADQNT_ID AS ZADACQID,
                ROUTE AS ZADROUTE1,
                VEND_ACC AS ZADVENAC1,
                VIR_STR AS ZADVIRSTO,
                PAY_GATE AS ZADPAYGAT,
                ORDER_ID AS ZADORDID1,
                RMA AS ZADRMA1,
                DATE_ADQ AS ZADFECHA1,
                TIMEZONE_ADQ AS ZADTMZN1,
                TRAN_AMNT AS ZADTRAMT1,
                TRAN_CURR AS ZADTRCUR1,
                TRAN_SET_AMNT AS ZADTRSAM1,
                TRAN_GRS_AMNT AS ZADTRGAM1,
                TRAN_NET_AMNT AS ZADTRNAM1,
                SET_CURR AS ZADSTCUR1,
                EXC_AMNT AS ZADEXAMN1,
                EXC_FRG_CURR AS ZADEXFCU1,
                EXC_RATE AS ZADEXRAT1,
                EXC_AMNT_CNVT AS ZADEXAMC1,
                COM_AMNT AS ZADCAMNT1,
                COM_AMNT_CURR AS ZADCAMCU1,
                TRAN_REF_NUM AS ZADTRFNU1,
                TRAN_REF_NUM2 AS ZADTRFNU2,
                ARN AS ZADARN1,
                RECLN_ID AS ZADRELID1,
                "/BIC/TIP_TRANS" AS "/BIC/ZADTRANS1",
                PAY_METHOD AS ZADPYMET1,
                "/BIC/MED_PAGO" AS "/BIC/ZADMEPAG1",
                BATCH_ID AS ZADBATID1,
                INST_PAID AS ZADINSPA1,
                TOT_AMNT_INST AS ZADTAMIN1,
                INTCHANGE AS ZADINCNG1,
                SCH_FEE AS ZADSCFEE1,
                MARKUP AS ZADMRKUP1,
                PAY_METH_CAT AS ZADPAYMC1,
                TRANS_ID AS ZADTRNID1,
                TRANS_AUTH_NUM AS ZADTRAUN1,
                TRANS_OPER_NUM AS ZADTROPN1,
                PAN_CARD_NUM AS ZADPANCN1,
                TERM_ID AS ZADTERID1,
                INSTALM AS "/BIC/ZADINST1",
                NUM_INSTAL AS ZADNINST1,
                DCC AS "/BIC/ZADDCC1",
                DCC_REB AS ZADDCCRB1,
                CARD_READ_MET AS ZADCRMTH1,
                LOYAL_POINT AS "/BIC/ZADLOYLP1",
                "/BIC/ZADTFILE1" AS "/BIC/ZADTFILE1",
                TYPE_CHAN AS ZADTCHAN1,
                AUX1 AS ZADAUX1,
                AUX2 AS ZADAUX2,
                AUX3 AS ZADAUX3,
                AUX4 AS ZADAUX4,
                AUX5 AS ZADAUX5,
                AUX6 AS ZADAUX6,
                AUX7 AS ZADAUX7,
                AUX8 AS ZADAUX8,
                AUX9 AS ZADAUX9,
                AUX10 AS ZADAUX10,
                '' AS ZADCALDAY,
                0 AS ZADFILNUM,
                RECORD,
                SQL__PROCEDURE__SOURCE__RECORD
                FROM :inTab
                WHERE REC_ID = 'AUX';

   t9 = SELECT  '' AS RECORDMODE,
                REC_ID AS ZADRECID1,
                LIN_NUM AS ZADLINUM1,
                ADQNT_ID AS ZADACQID,
                ROUTE AS ZADROUTE1,
                VEND_ACC AS ZADVENAC1,
                VIR_STR AS ZADVIRSTO,
                PAY_GATE AS ZADPAYGAT,
                ORDER_ID AS ZADORDID1,
                RMA AS ZADRMA1,
                DATE_ADQ AS ZADFECHA1,
                TIMEZONE_ADQ AS ZADTMZN1,
                TRAN_AMNT AS ZADTRAMT1,
                TRAN_CURR AS ZADTRCUR1,
                TRAN_SET_AMNT AS ZADTRSAM1,
                TRAN_GRS_AMNT AS ZADTRGAM1,
                TRAN_NET_AMNT AS ZADTRNAM1,
                SET_CURR AS ZADSTCUR1,
                EXC_AMNT AS ZADEXAMN1,
                EXC_FRG_CURR AS ZADEXFCU1,
                EXC_RATE AS ZADEXRAT1,
                EXC_AMNT_CNVT AS ZADEXAMC1,
                COM_AMNT AS ZADCAMNT1,
                COM_AMNT_CURR AS ZADCAMCU1,
                TRAN_REF_NUM AS ZADTRFNU1,
                TRAN_REF_NUM2 AS ZADTRFNU2,
                ARN AS ZADARN1,
                RECLN_ID AS ZADRELID1,
                "/BIC/TIP_TRANS" AS "/BIC/ZADTRANS1",
                PAY_METHOD AS ZADPYMET1,
                "/BIC/MED_PAGO" AS "/BIC/ZADMEPAG1",
                BATCH_ID AS ZADBATID1,
                INST_PAID AS ZADINSPA1,
                TOT_AMNT_INST AS ZADTAMIN1,
                INTCHANGE AS ZADINCNG1,
                SCH_FEE AS ZADSCFEE1,
                MARKUP AS ZADMRKUP1,
                PAY_METH_CAT AS ZADPAYMC1,
                TRANS_ID AS ZADTRNID1,
                TRANS_AUTH_NUM AS ZADTRAUN1,
                TRANS_OPER_NUM AS ZADTROPN1,
                PAN_CARD_NUM AS ZADPANCN1,
                TERM_ID AS ZADTERID1,
                INSTALM AS "/BIC/ZADINST1",
                NUM_INSTAL AS ZADNINST1,
                DCC AS "/BIC/ZADDCC1",
                DCC_REB AS ZADDCCRB1,
                CARD_READ_MET AS ZADCRMTH1,
                LOYAL_POINT AS "/BIC/ZADLOYLP1",
                "/BIC/ZADTFILE1" AS "/BIC/ZADTFILE1",
                TYPE_CHAN AS ZADTCHAN1,
                AUX1 AS ZADAUX1,
                AUX2 AS ZADAUX2,
                AUX3 AS ZADAUX3,
                AUX4 AS ZADAUX4,
                AUX5 AS ZADAUX5,
                AUX6 AS ZADAUX6,
                AUX7 AS ZADAUX7,
                AUX8 AS ZADAUX8,
                AUX9 AS ZADAUX9,
                AUX10 AS ZADAUX10,
                '' AS ZADCALDAY,
                0 AS ZADFILNUM,
                RECORD,
                SQL__PROCEDURE__SOURCE__RECORD
            FROM :inTab
            WHERE REC_ID = 'RES';

    outTab = SELECT * FROM :tAuxLin
                UNION ALL
                SELECT * FROM :t8
                UNION ALL
                SELECT * FROM :t9 ;
